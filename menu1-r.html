<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Healthy Meal Plan 7 Days</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://static.line-scdn.net/liff/edge/versions/2.26.0/sdk.js"></script>
  <style>
    /* ‚Ä¶(‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)‚Ä¶ */
  </style>
</head>
<body>
  <!-- ‚Ä¶‡∏™‡πà‡∏ß‡∏ô header/hero/‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‚Ä¶ -->

  <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å: ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô -->
  <section class="card" id="profileCard" hidden>
    <h3>üìá ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å)</h3>
    <p>‡∏Å‡∏£‡∏≠‡∏Å ‚Äú‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏Ñ‡πâ‡∏ä‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>
    <form class="form" id="profileForm">
      <input id="nickname" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô" required />
      <button class="btn" type="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</button>
    </form>
  </section>

  <!-- ‚Ä¶‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‚Ä¶ -->

<script>
  // ===== CONFIG =====
  const GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbyNKjdj-fCnZlfy7x4fmHScirMGEfHjvJmHKpGn-XO3UBzX5o_3ubERrYTLikIfLKWAdw/exec';
  const LIFF_ID = '2007996778-xk36NJZZ';
  const STORAGE_KEY = 'mealPlan.completed.v2';
  const OFFLINE_KEY  = 'mealPlan.queue';
  const PROFILE_KEY  = 'mealPlan.profile.saved';
  const ORIGIN_TAG   = location.host; // ‡∏™‡πà‡∏á‡πÅ‡∏ô‡∏ö‡πÑ‡∏õ‡∏Å‡∏±‡∏ö POST ‡πÄ‡∏û‡∏∑‡πà‡∏≠ debug

  // ===== DATA (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) =====
  const mealData = [ /* ‚Ä¶‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ 7 ‡∏ß‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‚Ä¶ */ ];

  // ===== STATE/UI (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) =====
  let completed = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  if(!Array.isArray(completed) || completed.length !== mealData.length){
    completed = Array(mealData.length).fill(false);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(completed));
  }

  let profile = null;

  function percentDone(){ return Math.round((completed.filter(Boolean).length/mealData.length)*100); }
  function updateProgressUI(){ /* ‚Ä¶‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‚Ä¶ */ }
  function renderCards(){ /* ‚Ä¶‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å onToggleDay ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å)‚Ä¶ */ }

  // ===== LIFF =====
  async function initLiff(){
    try{
      await liff.init({ liffId: LIFF_ID });
      if(!liff.isLoggedIn()) liff.login();
      const p = await liff.getProfile();
      profile = { userId:p.userId, displayName:p.displayName, pictureUrl:p.pictureUrl };
    }catch(e){
      console.warn('LIFF init failed ‚Üí ‡πÉ‡∏ä‡πâ‡πÇ‡∏´‡∏°‡∏î guest', e);
      profile = { userId:'guest', displayName:'', pictureUrl:'' };
    }
  }

  // ===== POST to GAS (‡πÄ‡∏û‡∏¥‡πà‡∏° error detail + origin) =====
  function makeClientId(dayIndex, done){
    const t = new Date().toISOString().slice(0,10);
    return `${profile?.userId || 'guest'}:${t}:d${dayIndex}:${done?'1':'0'}`;
  }

  async function postProgress({ dayIndex, done, percent, note='' }){
    const body = {
      userId: profile?.userId || 'guest',
      displayName: profile?.displayName || 'Guest',
      pictureUrl: profile?.pictureUrl || '',
      phone: '', email: '',
      dayIndex, done, percent,
      clientId: makeClientId(dayIndex, done),
      note
    };
    const url = GAS_ENDPOINT + `?origin=${encodeURIComponent(ORIGIN_TAG)}`;
    const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });

    // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î error ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà ok
    if (!res.ok) {
      const text = await res.text().catch(()=> '');
      throw new Error(`HTTP ${res.status} ‚Ä¢ ${text.slice(0,200)}`);
    }
    const json = await res.json().catch(()=> null);
    if (!json || !json.ok) {
      throw new Error(json?.error || 'unknown GAS error');
    }
    return json;
  }

  function queueOffline(payload){
    const q = JSON.parse(localStorage.getItem(OFFLINE_KEY) || '[]');
    q.push({ ts:Date.now(), ...payload });
    localStorage.setItem(OFFLINE_KEY, JSON.stringify(q));
  }

  async function flushQueue(){
    const q = JSON.parse(localStorage.getItem(OFFLINE_KEY) || '[]');
    if(!q.length) return;
    const p = percentDone();
    for(const item of q){
      try{ await postProgress({ dayIndex:item.idx, done:item.isDoneNow, percent:p }); }
      catch(e){ return; }
    }
    localStorage.removeItem(OFFLINE_KEY);
  }

  async function onToggleDay(idx, isDoneNow){
    const p = percentDone();
    try{
      await postProgress({ dayIndex:idx, done:isDoneNow, percent:p });
    }catch(e){
      console.error('Save failed:', e);
      queueOffline({ idx, isDoneNow });
      alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.message + '\n(‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏¥‡∏ß‡πÑ‡∏ß‡πâ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÅ‡∏•‡πâ‡∏ß)');
    }
  }

  // ===== ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÉ‡∏´‡πâ‡πÇ‡∏Ñ‡πâ‡∏ä (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) =====
  async function sendResultToCoach(){ /* ‚Ä¶‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‚Ä¶ */ }

  // ===== ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å) =====
  function showProfileFormIfNeeded(){
    const saved = localStorage.getItem(PROFILE_KEY)==='1';
    if(!saved) document.getElementById('profileCard').hidden = false;
  }

  document.addEventListener('DOMContentLoaded', async ()=>{
    await initLiff();
    showProfileFormIfNeeded();
    await flushQueue();
    renderCards(); updateProgressUI();

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô ‚Üí ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÅ‡∏ñ‡∏ß (dayIndex = -1, note='register:nickname')
    document.getElementById('profileForm')?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const nickname = document.getElementById('nickname').value.trim();
      // ‡∏ñ‡πâ‡∏≤ LIFF ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠ ‚Üí ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô displayName
      if (!profile.displayName) profile.displayName = nickname || 'Guest';
      try{
        const result = await postProgress({ dayIndex:-1, done:false, percent:0, note:`register:${nickname}` });
        localStorage.setItem(PROFILE_KEY,'1');
        document.getElementById('profileCard').hidden = true;
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚úÖ' + (result?.dedup ? ' (‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥)' : ''));
      }catch(err){
        console.error(err);
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
      }
    });
  });

  // ‡∏õ‡∏∏‡πà‡∏°‡∏•‡πà‡∏≤‡∏á
  document.getElementById('sendBtn').addEventListener('click', sendResultToCoach);
  document.getElementById('resetBtn').addEventListener('click', ()=>{
    if(confirm('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')){
      completed = Array(mealData.length).fill(false);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(completed));
      renderCards(); updateProgressUI();
    }
  });
</script>
</body>
</html>
