<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Healthy Meal Plan 7 Days</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://static.line-scdn.net/liff/edge/versions/2.26.0/sdk.js"></script>
  <style>
    :root{--bg:#f0f7f2;--bg-soft:#e8f5e9;--surface:#ffffffcc;--surface-strong:#fff;--primary:#2e7d32;--primary-600:#1b5e20;--primary-300:#66bb6a;--text:#1f2937;--muted:#6b7280;--ring:#34d399;--radius:14px;--shadow:0 8px 24px rgba(0,0,0,.08);--blur:10px;--card-grad:linear-gradient(180deg,rgba(255,255,255,.75),rgba(255,255,255,.95))}
    @media(prefers-color-scheme:dark){:root{--bg:#0b1210;--bg-soft:#0f1a14;--surface:#0f1a14cc;--surface-strong:#111c17;--primary:#7ddc8a;--primary-600:#58b86b;--primary-300:#a8e8b1;--text:#e5e7eb;--muted:#94a3b8;--ring:#34d399;--card-grad:linear-gradient(180deg,rgba(17,28,23,.7),rgba(17,28,23,.95));--shadow:0 8px 24px rgba(0,0,0,.35)}}
    *{box-sizing:border-box}
    body{margin:0;font-family:'Kanit',system-ui,Segoe UI,Roboto,sans-serif;background:
      radial-gradient(1200px 600px at 100% 0,var(--bg-soft) 0%,transparent 60%),
      radial-gradient(800px 400px at 0 100%,var(--bg-soft) 0%,transparent 60%),
      var(--bg);color:var(--text);line-height:1.65;padding-bottom:56px}
    .appbar{position:sticky;top:0;z-index:20;backdrop-filter:blur(var(--blur));background:linear-gradient(180deg,rgba(255,255,255,.7),rgba(255,255,255,.45));border-bottom:1px solid rgba(0,0,0,.06);box-shadow:0 6px 16px rgba(0,0,0,.04)}
    @media(prefers-color-scheme:dark){.appbar{background:linear-gradient(180deg,rgba(17,28,23,.7),rgba(17,28,23,.45));border-color:rgba(255,255,255,.06)}}
    .appbar-inner{max-width:960px;margin:0 auto;padding:14px 16px;display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:40px;height:40px;border-radius:12px;background:conic-gradient(from 210deg,var(--primary) 0 40%,#8BC34A 40% 70%,#34d399 70% 100%);box-shadow:inset 0 0 0 2px #ffffff22,var(--shadow)}
    .brand h1{margin:0;font-size:1.25rem;font-weight:700}
    .sub{font-size:.9rem;color:var(--muted)}
    .container{max-width:960px;margin:18px auto;padding:0 16px}
    .hero{background:linear-gradient(135deg,var(--primary) 0%,var(--primary-600) 60%);color:#fff;padding:18px;border-radius:var(--radius);box-shadow:var(--shadow)}
    .hero h2{margin:4px 0 6px;font-size:1.3rem}
    .progress{margin-top:10px;background:rgba(255,255,255,.25);border-radius:999px;height:14px;overflow:hidden}
    .bar{--val:0%;width:var(--val);height:100%;background:linear-gradient(90deg,#fff,#c8f7d2);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.78rem;color:#0b0b0b;transition:width .45s ease}
    section.card{background:var(--card-grad);backdrop-filter:blur(var(--blur));border:1px solid rgba(0,0,0,.06);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;margin:18px 0}
    section.card h3{margin:0 0 10px;font-size:1.1rem;color:var(--primary)}
    .kp{list-style:none;padding:0;margin:0;display:grid;gap:10px}
    .kp li{background:var(--surface);border:1px dashed rgba(0,0,0,.08);padding:12px;border-radius:12px}
    .grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fill,minmax(280px,1fr))}
    .meal{position:relative;background:var(--surface-strong);border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid rgba(0,0,0,.06);overflow:hidden;transition:transform .2s ease,box-shadow .2s ease}
    .meal:hover{transform:translateY(-2px);box-shadow:0 10px 28px rgba(0,0,0,.1)}
    .meal-head{background:linear-gradient(90deg,var(--primary) 0,var(--primary-300));color:#fff;padding:12px 14px;text-align:center;font-weight:700}
    .meal-body{padding:14px 14px 60px}
    .item{margin:10px 0}
    .item h4{margin:0 0 4px;color:var(--primary);font-size:1rem}
    .badge{display:inline-block;background:#e8f5e9;color:var(--primary);border:1px solid #b7e0bf;padding:2px 8px;border-radius:999px;font-size:.78rem;font-weight:700}
    @media(prefers-color-scheme:dark){.badge{background:#14231a;border-color:#21452f}}
    .check{position:absolute;right:10px;top:8px;font-size:1.4rem;display:none}
    .meal.done .check{display:block}
    .btn{appearance:none;border:none;cursor:pointer;font:inherit;padding:10px 14px;border-radius:12px;background:var(--primary);color:#fff;font-weight:700;width:calc(100% - 28px);margin:0 14px 12px;transition:transform .1s ease,background .2s ease,box-shadow .2s ease;box-shadow:0 6px 18px rgba(46,125,50,.28)}
    .btn:hover{transform:translateY(-1px);background:var(--primary-600)}
    .btn.done,.btn[disabled]{background:#a5d6a7;color:#0b0b0b;box-shadow:none;cursor:not-allowed}
    .actions{position:fixed;left:0;right:0;bottom:0;z-index:30;backdrop-filter:blur(var(--blur));background:linear-gradient(180deg,rgba(255,255,255,.4),rgba(255,255,255,.7));border-top:1px solid rgba(0,0,0,.06);padding:10px 12px}
    @media(prefers-color-scheme:dark){.actions{background:linear-gradient(180deg,rgba(17,28,23,.4),rgba(17,28,23,.7));border-color:rgba(255,255,255,.06)}}
    .actions-inner{max-width:960px;margin:0 auto;display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn-outline{background:transparent;color:var(--primary);border:2px solid var(--primary);box-shadow:none}
    .btn-outline:hover{background:var(--primary);color:#fff}
    footer{text-align:center;color:var(--muted);padding:24px 0}
    :is(button,a).btn:focus-visible,.btn-outline:focus-visible{outline:none;box-shadow:0 0 0 3px #fff,0 0 0 6px var(--ring)}
    @media(max-width:600px){.brand h1{font-size:1.1rem}.hero h2{font-size:1.15rem}}
    @media print{.appbar,.actions{display:none!important}body{background:#fff}section.card,.meal{break-inside:avoid}}
    .form{display:grid;gap:10px;margin-top:10px}
    .form input{padding:10px 12px;border-radius:10px;border:1px solid #d1d5db}
    .form button{justify-self:start}
  </style>
</head>
<body>
  <header class="appbar">
    <div class="appbar-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Healthy Meal Plan 7 Days</h1>
          <div class="sub">‡∏™‡∏π‡∏ï‡∏£‡∏Ñ‡∏∏‡∏°‡∏Ñ‡∏≤‡∏£‡πå‡∏ö 2 ‡∏°‡∏∑‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å/‡∏ß‡∏±‡∏ô ‚Äî ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠</div>
        </div>
      </div>
      <div aria-live="polite" style="text-align:right;">
        <span class="badge" id="progress-mini">0% ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>
      </div>
    </div>
  </header>

  <main class="container" id="app">
    <section class="hero">
      <h2>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô</h2>
      <p>‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤ <strong>‡∏Ñ‡∏≤‡∏£‡πå‡∏ö 100 ‡∏Å‡∏£‡∏±‡∏°</strong> ‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô <strong>Low-Carb</strong> ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏•‡∏µ‡∏ô + ‡∏ú‡∏±‡∏Å‡∏´‡∏•‡∏≤‡∏Å‡∏™‡∏µ</p>
      <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-label="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏ß‡∏°">
        <div class="bar" id="bar">0%</div>
      </div>
    </section>

    <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å: ‡πÉ‡∏ä‡πâ‡πÅ‡∏Ñ‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô -->
    <section class="card" id="profileCard" hidden>
      <h3>üìá ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å)</h3>
      <p>‡∏Å‡∏£‡∏≠‡∏Å ‚Äú‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‚Äù ‡πÉ‡∏´‡πâ‡πÇ‡∏Ñ‡πâ‡∏ä‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>
      <form class="form" id="profileForm">
        <input id="nickname" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô" required />
        <button class="btn" type="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</button>
      </form>
    </section>

    <section class="card">
      <h3>üîë ‡∏à‡∏∏‡∏î‡πÄ‡∏î‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏ú‡∏ô</h3>
      <ul class="kp">
        <li><strong>‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡πÄ‡∏ä‡πâ‡∏≤ 100 ‡∏Å‡∏£‡∏±‡∏°:</strong> ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏û‡∏≠‡∏î‡∏µ ‡πÑ‡∏°‡πà‡∏û‡∏∏‡πà‡∏á‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•</li>
        <li><strong>‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô 100‚Äì120 ‡∏Å‡∏£‡∏±‡∏°/‡∏°‡∏∑‡πâ‡∏≠:</strong> ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏°‡∏ß‡∏•‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠</li>
        <li><strong>‡∏ú‡∏±‡∏Å 250‚Äì400 ‡∏Å‡∏£‡∏±‡∏°/‡∏°‡∏∑‡πâ‡∏≠:</strong> ‡πÑ‡∏ü‡πÄ‡∏ö‡∏≠‡∏£‡πå ‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô ‡πÅ‡∏£‡πà‡∏ò‡∏≤‡∏ï‡∏∏‡∏Ñ‡∏£‡∏ö</li>
        <li><strong>‡∏ú‡∏•‡πÑ‡∏°‡πâ Low-GI ‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏™‡πà‡∏ß‡∏ô:</strong> ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏∏‡∏°‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•</li>
      </ul>
    </section>

    <section class="card">
      <h3>üìÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£ 7 ‡∏ß‡∏±‡∏ô</h3>
      <div id="grid" class="grid" aria-live="polite"></div>
    </section>

    <footer>¬© 2024 Healthy Meal Plan. All rights reserved.</footer>
  </main>

  <div class="actions" role="region" aria-label="‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏î‡πà‡∏ß‡∏ô">
    <div class="actions-inner">
      <button class="btn" id="sendBtn">‡∏™‡πà‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÉ‡∏´‡πâ‡πÇ‡∏Ñ‡πâ‡∏ä‡∏ú‡πà‡∏≤‡∏ô LINE</button>
      <button class="btn btn-outline" id="resetBtn">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</button>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbyNKjdj-fCnZlfy7x4fmHScirMGEfHjvJmHKpGn-XO3UBzX5o_3ubERrYTLikIfLKWAdw/exec';
    const LIFF_ID = '2007996778-xk36NJZZ';
    const STORAGE_KEY = 'mealPlan.completed.v2';
    const OFFLINE_KEY = 'mealPlan.queue';
    const PROFILE_KEY = 'mealPlan.profile.saved';
    const ORIGIN_TAG = location.host;

    // ===== DATA =====
    const mealData = [
      { day:"‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå", theme:"‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏î‡πÉ‡∏™", meals:[
        { time:"‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤ (‡∏Ñ‡∏≤‡∏£‡πå‡∏ö 100g)", menu:"‡∏Ç‡πâ‡∏≤‡∏ß‡∏Å‡∏•‡πâ‡∏≠‡∏á 100 ‡∏Å‡∏£‡∏±‡∏°, ‡∏≠‡∏Å‡πÑ‡∏Å‡πà‡∏¢‡πà‡∏≤‡∏á 100 ‡∏Å‡∏£‡∏±‡∏°, ‡∏ú‡∏±‡∏Å 5 ‡∏™‡∏µ 300 ‡∏Å‡∏£‡∏±‡∏°", reason:"‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡πÄ‡∏ä‡∏¥‡∏á‡∏ã‡πâ‡∏≠‡∏ô + ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏•‡∏µ‡∏ô + ‡πÉ‡∏¢‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏π‡∏á" },
        { time:"‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô (‡πÇ‡∏•‡∏ß‡πå‡∏Ñ‡∏≤‡∏£‡πå‡∏ö)", menu:"‡∏õ‡∏•‡∏≤‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå‡∏¢‡πà‡∏≤‡∏á 120 ‡∏Å‡∏£‡∏±‡∏°, ‡πÅ‡∏Å‡∏á‡πÄ‡∏•‡∏µ‡∏¢‡∏á 400 ‡∏Å‡∏£‡∏±‡∏°, ‡∏ù‡∏£‡∏±‡πà‡∏á 100 ‡∏Å‡∏£‡∏±‡∏°", reason:"‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏à‡∏≤‡∏Å‡∏õ‡∏•‡∏≤ + ‡∏ú‡∏±‡∏Å‡∏´‡∏•‡∏≤‡∏Å‡∏™‡∏µ" }
      ]},
      { day:"‡∏ß‡∏±‡∏ô‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£", theme:"‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏î‡∏µ‡πÅ‡∏•‡∏∞‡∏†‡∏π‡∏°‡∏¥‡∏Ñ‡∏∏‡πâ‡∏°‡∏Å‡∏±‡∏ô", meals:[
        { time:"‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤ (‡∏Ñ‡∏≤‡∏£‡πå‡∏ö 100g)", menu:"‡∏Ç‡πâ‡∏≤‡∏ß‡∏™‡∏ß‡∏¢ 100 ‡∏Å‡∏£‡∏±‡∏°, ‡πÑ‡∏Ç‡πà‡∏ï‡πâ‡∏° 2 ‡∏ü‡∏≠‡∏á, ‡∏ú‡∏±‡∏î‡∏ú‡∏±‡∏Å‡∏ö‡∏∏‡πâ‡∏á 250 ‡∏Å‡∏£‡∏±‡∏°", reason:"‡πÑ‡∏Ç‡πà‡πÅ‡∏î‡∏á‡∏°‡∏µ‡πÇ‡∏Ñ‡∏•‡∏µ‡∏ô + ‡πÑ‡∏ü‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏™‡∏π‡∏á" },
        { time:"‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô (‡πÇ‡∏•‡∏ß‡πå‡∏Ñ‡∏≤‡∏£‡πå‡∏ö)", menu:"‡∏≠‡∏Å‡πÑ‡∏Å‡πà‡∏≠‡∏ö‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£ 120 ‡∏Å‡∏£‡∏±‡∏°, ‡∏¢‡∏≥‡πÄ‡∏´‡πá‡∏î‡∏£‡∏ß‡∏° 300 ‡∏Å‡∏£‡∏±‡∏°, ‡πÅ‡∏ï‡∏á‡∏Å‡∏ß‡∏≤ 200 ‡∏Å‡∏£‡∏±‡∏°", reason:"‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏•‡∏µ‡∏ô + ‡πÄ‡∏ö‡∏ï‡πâ‡∏≤-‡∏Å‡∏•‡∏π‡πÅ‡∏Ñ‡∏ô" }
      ]},
      { day:"‡∏ß‡∏±‡∏ô‡∏û‡∏∏‡∏ò", theme:"‡πÄ‡∏ï‡∏¥‡∏°‡∏û‡∏•‡∏±‡∏á‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢", meals:[
        { time:"‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤ (‡∏Ñ‡∏≤‡∏£‡πå‡∏ö 100g)", menu:"‡∏Ç‡πâ‡∏≤‡∏ß‡∏Å‡∏•‡πâ‡∏≠‡∏á 100 ‡∏Å‡∏£‡∏±‡∏°, ‡∏≠‡∏Å‡πÑ‡∏Å‡πà 100 ‡∏Å‡∏£‡∏±‡∏°, ‡∏ï‡πâ‡∏°‡∏à‡∏∑‡∏î‡πÄ‡∏ï‡πâ‡∏≤‡∏´‡∏π‡πâ‡∏™‡∏≤‡∏´‡∏£‡πà‡∏≤‡∏¢ 250 ‡∏Å‡∏£‡∏±‡∏°, ‡∏ú‡∏±‡∏Å‡∏™‡∏î 100 ‡∏Å‡∏£‡∏±‡∏°", reason:"‡∏¢‡πà‡∏≠‡∏¢‡∏á‡πà‡∏≤‡∏¢ ‡πÑ‡∏≠‡πÇ‡∏≠‡∏î‡∏µ‡∏ô/‡πÅ‡∏Ñ‡∏•‡πÄ‡∏ã‡∏µ‡∏¢‡∏°" },
        { time:"‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô (‡πÇ‡∏•‡∏ß‡πå‡∏Ñ‡∏≤‡∏£‡πå‡∏ö)", menu:"‡∏•‡∏≤‡∏ö‡∏≠‡∏Å‡πÑ‡∏Å‡πà 120 ‡∏Å‡∏£‡∏±‡∏°, ‡∏ú‡∏±‡∏Å‡∏™‡∏î 200 ‡∏Å‡∏£‡∏±‡∏°, ‡∏ä‡∏°‡∏û‡∏π‡πà 120 ‡∏Å‡∏£‡∏±‡∏°", reason:"‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏™‡∏π‡∏á ‡πÄ‡∏ö‡∏≤‡∏ó‡πâ‡∏≠‡∏á" }
      ]},
      { day:"‡∏ß‡∏±‡∏ô‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ", theme:"‡πÇ‡∏≠‡πÄ‡∏°‡∏Å‡πâ‡∏≤-3 ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î", meals:[
        { time:"‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤ (‡∏Ñ‡∏≤‡∏£‡πå‡∏ö 100g)", menu:"‡∏Ç‡πâ‡∏≤‡∏ß‡∏™‡∏ß‡∏¢ 100 ‡∏Å‡∏£‡∏±‡∏°, ‡∏õ‡∏•‡∏≤‡∏ó‡∏π‡∏¢‡πà‡∏≤‡∏á ~100 ‡∏Å‡∏£‡∏±‡∏°, ‡∏ú‡∏±‡∏î‡∏ú‡∏±‡∏Å‡∏£‡∏ß‡∏° 250 ‡∏Å‡∏£‡∏±‡∏°, ‡πÑ‡∏Ç‡πà‡∏ï‡πâ‡∏° 1 ‡∏ü‡∏≠‡∏á", reason:"‡∏õ‡∏•‡∏≤‡∏ó‡∏π‡∏´‡∏≤‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢" },
        { time:"‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô (‡πÇ‡∏•‡∏ß‡πå‡∏Ñ‡∏≤‡∏£‡πå‡∏ö)", menu:"‡πÑ‡∏Å‡πà‡∏¢‡πà‡∏≤‡∏á 120 ‡∏Å‡∏£‡∏±‡∏°, ‡∏™‡πâ‡∏°‡∏ï‡∏≥‡πÑ‡∏ó‡∏¢ 300 ‡∏Å‡∏£‡∏±‡∏°, ‡πÅ‡∏ï‡∏á‡∏Å‡∏ß‡∏≤ 200 ‡∏Å‡∏£‡∏±‡∏°", reason:"‡∏ú‡∏±‡∏Å‡∏à‡∏±‡∏î‡πÄ‡∏ï‡πá‡∏° ‡∏•‡∏î‡∏Ñ‡∏≤‡∏£‡πå‡∏ö" }
      ]},
      { day:"‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå", theme:"‡∏≠‡∏¥‡πà‡∏°‡∏≠‡∏£‡πà‡∏≠‡∏¢‡πÅ‡∏ö‡∏ö‡∏ö‡πâ‡∏≤‡∏ô‡πÜ", meals:[
        { time:"‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤ (‡∏Ñ‡∏≤‡∏£‡πå‡∏ö 100g)", menu:"‡∏Ç‡πâ‡∏≤‡∏ß‡∏Å‡∏•‡πâ‡∏≠‡∏á 100 ‡∏Å‡∏£‡∏±‡∏°, ‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß‡∏´‡∏≠‡∏°‡πÉ‡∏´‡∏ç‡πà 2 ‡∏ü‡∏≠‡∏á (‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô 1 ‡∏ä‡∏ä.), ‡∏ö‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏•‡∏µ+‡πÅ‡∏Ñ‡∏£‡∏≠‡∏ó 250 ‡∏Å‡∏£‡∏±‡∏°", reason:"‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô + ‡πÉ‡∏¢‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏π‡∏á" },
        { time:"‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô (‡πÇ‡∏•‡∏ß‡πå‡∏Ñ‡∏≤‡∏£‡πå‡∏ö)", menu:"‡∏™‡∏∏‡∏Å‡∏µ‡πâ‡∏ô‡πâ‡∏≥‡πÉ‡∏™‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏ß‡∏∏‡πâ‡∏ô‡πÄ‡∏™‡πâ‡∏ô ‡∏ú‡∏±‡∏Å 300 ‡∏Å‡∏£‡∏±‡∏° + ‡πÑ‡∏Å‡πà 100 ‡∏Å‡∏£‡∏±‡∏° + ‡πÄ‡∏ï‡πâ‡∏≤‡∏´‡∏π‡πâ 50 ‡∏Å‡∏£‡∏±‡∏°, ‡∏ù‡∏£‡∏±‡πà‡∏á 100 ‡∏Å‡∏£‡∏±‡∏°", reason:"‡∏≠‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏±‡∏Å ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏Ñ‡∏£‡∏ö" }
      ]},
      { day:"‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå", theme:"‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏™‡∏°‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ß‡πÉ‡∏à", meals:[
        { time:"‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤ (‡∏Ñ‡∏≤‡∏£‡πå‡∏ö 100g)", menu:"‡∏Ç‡πâ‡∏≤‡∏ß‡∏™‡∏ß‡∏¢ 100 ‡∏Å‡∏£‡∏±‡∏°, ‡πÅ‡∏ã‡∏•‡∏°‡∏≠‡∏ô‡∏¢‡πà‡∏≤‡∏á 120 ‡∏Å‡∏£‡∏±‡∏°, ‡∏™‡∏•‡∏±‡∏î‡∏ú‡∏±‡∏Å 250 ‡∏Å‡∏£‡∏±‡∏°", reason:"DHA/EPA ‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏°‡∏≤‡∏ò‡∏¥" },
        { time:"‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô (‡πÇ‡∏•‡∏ß‡πå‡∏Ñ‡∏≤‡∏£‡πå‡∏ö)", menu:"‡∏¢‡∏≥‡∏ß‡∏∏‡πâ‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ú‡∏±‡∏Å‡∏£‡∏ß‡∏° 300 ‡∏Å‡∏£‡∏±‡∏° + ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô 100 ‡∏Å‡∏£‡∏±‡∏°, ‡∏ú‡∏±‡∏Å‡∏™‡∏î 150 ‡∏Å‡∏£‡∏±‡∏°", reason:"‡∏™‡∏≤‡∏£‡∏ï‡πâ‡∏≤‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏π‡∏•‡∏≠‡∏¥‡∏™‡∏£‡∏∞‡∏à‡∏≤‡∏Å‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£" }
      ]},
      { day:"‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå", theme:"‡∏õ‡∏¥‡∏î‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£", meals:[
        { time:"‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤ (‡∏Ñ‡∏≤‡∏£‡πå‡∏ö 100g)", menu:"‡∏Ç‡πâ‡∏≤‡∏ß‡∏Å‡∏•‡πâ‡∏≠‡∏á 100 ‡∏Å‡∏£‡∏±‡∏°, ‡πÑ‡∏Å‡πà‡∏ï‡πâ‡∏°‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£ 120 ‡∏Å‡∏£‡∏±‡∏°, ‡πÅ‡∏Å‡∏á‡πÄ‡∏•‡∏µ‡∏¢‡∏á 300 ‡∏Å‡∏£‡∏±‡∏°", reason:"‡∏ï‡∏∞‡πÑ‡∏Ñ‡∏£‡πâ ‡πÉ‡∏ö‡∏°‡∏∞‡∏Å‡∏£‡∏π‡∏î ‡∏•‡∏î‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö" },
        { time:"‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô (‡πÇ‡∏•‡∏ß‡πå‡∏Ñ‡∏≤‡∏£‡πå‡∏ö)", menu:"‡∏ï‡πâ‡∏°‡∏¢‡∏≥‡∏Å‡∏∏‡πâ‡∏á 250 ‡∏Å‡∏£‡∏±‡∏°, ‡∏ú‡∏±‡∏Å‡∏™‡∏î/‡∏•‡∏ß‡∏Å 200 ‡∏Å‡∏£‡∏±‡∏°, ‡∏ä‡∏°‡∏û‡∏π‡πà/‡∏™‡πâ‡∏° 100 ‡∏Å‡∏£‡∏±‡∏°", reason:"‡∏ã‡∏∏‡∏õ‡πÉ‡∏™‡∏¢‡πà‡∏≠‡∏¢‡∏á‡πà‡∏≤‡∏¢" }
      ]}
    ];

    // ===== STATE/UI =====
    let completed = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    if(!Array.isArray(completed) || completed.length !== mealData.length){
      completed = Array(mealData.length).fill(false);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(completed));
    }

    let profile = null;
    const grid = document.getElementById('grid');
    const bar = document.getElementById('bar');
    const mini = document.getElementById('progress-mini');

    function percentDone(){ return Math.round((completed.filter(Boolean).length/mealData.length)*100); }
    function updateProgressUI(){
      const p = percentDone();
      bar.style.setProperty('--val', p + '%');
      bar.textContent = p + '%';
      bar.setAttribute('aria-valuenow', p);
      mini.textContent = `${p}% ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`;
    }

    function renderCards(){
      grid.innerHTML='';
      mealData.forEach((d, idx)=>{
        const card = document.createElement('article');
        card.className = 'meal' + (completed[idx] ? ' done':'');
        card.setAttribute('aria-labelledby', `h-${idx}`);

        const head = document.createElement('div');
        head.className='meal-head';
        head.innerHTML = `<div id="h-${idx}">${d.day} ‚Ä¢ ${d.theme}</div>`;
        card.appendChild(head);

        const body = document.createElement('div');
        body.className='meal-body';
        d.meals.forEach(meal=>{
          const wrap = document.createElement('div');
          wrap.className='item';
          wrap.innerHTML = `
            <h4>${meal.time} <span class="badge">${meal.time.includes('‡∏Ñ‡∏≤‡∏£‡πå‡∏ö 100')?'‡∏Ñ‡∏∏‡∏°‡∏Ñ‡∏≤‡∏£‡πå‡∏ö':'Low-Carb'}</span></h4>
            <p><strong>‡πÄ‡∏°‡∏ô‡∏π:</strong> ${meal.menu}</p>
            <p><strong>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:</strong> ${meal.reason}</p>
          `;
          body.appendChild(wrap);
        });
        card.appendChild(body);

        const check = document.createElement('span');
        check.className='check';
        check.textContent='‚úîÔ∏è';
        check.setAttribute('aria-hidden','true');
        card.appendChild(check);

        const btn = document.createElement('button');
        btn.className = 'btn' + (completed[idx] ? ' done':'');
        btn.textContent = completed[idx] ? '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏≥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!' : '‡∏â‡∏±‡∏ô‡∏ó‡∏≥‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß';
        btn.addEventListener('click', async ()=>{
          completed[idx] = !completed[idx];
          localStorage.setItem(STORAGE_KEY, JSON.stringify(completed));
          renderCards(); updateProgressUI();
          await onToggleDay(idx, completed[idx]);
        });
        card.appendChild(btn);

        grid.appendChild(card);
      });
    }

    // ===== LIFF / PROFILE =====
    async function initLiff(){
      try{
        await liff.init({ liffId: LIFF_ID });
        if(!liff.isLoggedIn()) liff.login();
        const p = await liff.getProfile();
        profile = { userId:p.userId, displayName:p.displayName, pictureUrl:p.pictureUrl };
      }catch(e){
        console.warn('LIFF init failed, continue as guest', e);
        profile = { userId:'guest', displayName:'', pictureUrl:'' };
      }
    }

    function makeClientId(dayIndex, done){
      const t = new Date().toISOString().slice(0,10);
      return `${profile?.userId || 'guest'}:${t}:d${dayIndex}:${done?'1':'0'}`;
    }

    async function postProgress({ dayIndex, done, percent, note='' }){
      const body = {
        userId: profile?.userId || 'guest',
        displayName: (profile?.displayName && profile.displayName.trim()) || localStorage.getItem('nickname') || 'Guest',
        pictureUrl: profile?.pictureUrl || '',
        phone: '', email: '',
        dayIndex, done, percent,
        clientId: makeClientId(dayIndex, done),
        note
      };
      const url = GAS_ENDPOINT + `?origin=${encodeURIComponent(ORIGIN_TAG)}`;
      const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
      if (!res.ok) {
        const t = await res.text().catch(()=> '');
        throw new Error(`HTTP ${res.status} ‚Ä¢ ${t.slice(0,200)}`);
      }
      const json = await res.json().catch(()=> null);
      if (!json || !json.ok) throw new Error(json?.error || 'unknown GAS error');
      return json;
    }

    function queueOffline(payload){
      const q = JSON.parse(localStorage.getItem(OFFLINE_KEY) || '[]');
      q.push({ ts:Date.now(), ...payload });
      localStorage.setItem(OFFLINE_KEY, JSON.stringify(q));
    }

    async function flushQueue(){
      const q = JSON.parse(localStorage.getItem(OFFLINE_KEY) || '[]');
      if(!q.length) return;
      const p = percentDone();
      for(const item of q){
        try{ await postProgress({ dayIndex:item.idx, done:item.isDoneNow, percent:p }); }
        catch(e){ return; }
      }
      localStorage.removeItem(OFFLINE_KEY);
    }

    async function onToggleDay(idx, isDoneNow){
      const p = percentDone();
      try{
        await postProgress({ dayIndex:idx, done:isDoneNow, percent:p });
      }catch(e){
        console.error('Save failed:', e);
        queueOffline({ idx, isDoneNow });
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.message + '\n(‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏¥‡∏ß‡πÑ‡∏ß‡πâ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÅ‡∏•‡πâ‡∏ß)');
      }
    }

    async function sendResultToCoach(){
      const p = percentDone();
      const days = mealData.map((d,i)=> completed[i] ? `‚úÖ ${d.day}` : `‚¨ú ${d.day}`).join('\n');
      const text = `‡∏ú‡∏°/‡∏´‡∏ô‡∏π‡∏ó‡∏≥‡πÅ‡∏ú‡∏ô 7 ‡∏ß‡∏±‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ${p}% üéâ\n‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤:\n${days}\n\n‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥/‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡πâ‡∏ä‡∏Ñ‡∏£‡∏±‡∏ö üôè`;
      try{
        if(!profile) await initLiff();
        if(window.liff && typeof liff.init==='function'){
          if(!liff.isLoggedIn()) liff.login();
          await liff.sendMessages([{ type:'text', text }]);
          alert('‡∏™‡πà‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!');
        }else{ throw new Error('No LIFF'); }
      }catch(e){
        navigator.clipboard?.writeText(text);
        alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß ‚úì ‡∏ô‡∏≥‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡πÉ‡∏ô LINE ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡πÇ‡∏Ñ‡πâ‡∏ä');
      }
    }

    function showProfileFormIfNeeded(){
      const saved = localStorage.getItem(PROFILE_KEY)==='1';
      if(!saved) document.getElementById('profileCard').hidden = false;
    }

    document.getElementById('sendBtn').addEventListener('click', sendResultToCoach);
    document.getElementById('resetBtn').addEventListener('click', ()=>{
      if(confirm('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')){
        completed = Array(mealData.length).fill(false);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(completed));
        renderCards(); updateProgressUI();
      }
    });

    document.addEventListener('DOMContentLoaded', async ()=>{
      await initLiff();
      showProfileFormIfNeeded();
      await flushQueue();
      renderCards(); updateProgressUI();

      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
      document.getElementById('profileForm')?.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const nickname = document.getElementById('nickname').value.trim();
        localStorage.setItem('nickname', nickname);
        if (!profile.displayName) profile.displayName = nickname || 'Guest';
        try{
          await postProgress({ dayIndex:-1, done:false, percent:0, note:`register:${nickname}` });
          localStorage.setItem(PROFILE_KEY,'1');
          document.getElementById('profileCard').hidden = true;
          alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚úÖ');
        }catch(err){
          alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
        }
      });
    });
  </script>
</body>
</html>
